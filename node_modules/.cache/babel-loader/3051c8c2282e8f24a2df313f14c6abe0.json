{"ast":null,"code":"import { Transform, tupleid } from 'vega-dataflow';\nimport { fastmap, inherits } from 'vega-util';\n/**\n * Filters data tuples according to a predicate function.\n * @constructor\n * @param {object} params - The parameters for this operator.\n * @param {function(object): *} params.expr - The predicate expression function\n *   that determines a tuple's filter status. Truthy values pass the filter.\n */\n\nexport default function Filter(params) {\n  Transform.call(this, fastmap(), params);\n}\nFilter.Definition = {\n  \"type\": \"Filter\",\n  \"metadata\": {\n    \"changes\": true\n  },\n  \"params\": [{\n    \"name\": \"expr\",\n    \"type\": \"expr\",\n    \"required\": true\n  }]\n};\nvar prototype = inherits(Filter, Transform);\n\nprototype.transform = function (_, pulse) {\n  var df = pulse.dataflow,\n      cache = this.value,\n      // cache ids of filtered tuples\n  output = pulse.fork(),\n      add = output.add,\n      rem = output.rem,\n      mod = output.mod,\n      test = _.expr,\n      isMod = true;\n  pulse.visit(pulse.REM, function (t) {\n    var id = tupleid(t);\n    if (!cache.has(id)) rem.push(t);else cache.delete(id);\n  });\n  pulse.visit(pulse.ADD, function (t) {\n    if (test(t, _)) add.push(t);else cache.set(tupleid(t), 1);\n  });\n\n  function revisit(t) {\n    var id = tupleid(t),\n        b = test(t, _),\n        s = cache.get(id);\n\n    if (b && s) {\n      cache.delete(id);\n      add.push(t);\n    } else if (!b && !s) {\n      cache.set(id, 1);\n      rem.push(t);\n    } else if (isMod && b && !s) {\n      mod.push(t);\n    }\n  }\n\n  pulse.visit(pulse.MOD, revisit);\n\n  if (_.modified()) {\n    isMod = false;\n    pulse.visit(pulse.REFLOW, revisit);\n  }\n\n  if (cache.empty > df.cleanThreshold) df.runAfter(cache.clean);\n  return output;\n};","map":null,"metadata":{},"sourceType":"module"}