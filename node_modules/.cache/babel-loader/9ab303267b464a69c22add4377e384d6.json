{"ast":null,"code":"import { context } from './canvas/context';\nimport { isArray } from 'vega-util';\nvar currFontHeight;\nexport var textMetrics = {\n  height: fontSize,\n  measureWidth: measureWidth,\n  estimateWidth: estimateWidth,\n  width: estimateWidth,\n  canvas: useCanvas\n};\nuseCanvas(true); // make dumb, simple estimate if no canvas is available\n\nfunction estimateWidth(item, text) {\n  currFontHeight = fontSize(item);\n  return estimate(textValue(item, text));\n}\n\nfunction estimate(text) {\n  return ~~(0.8 * text.length * currFontHeight);\n} // measure text width if canvas is available\n\n\nfunction measureWidth(item, text) {\n  return fontSize(item) <= 0 ? 0 : (context.font = font(item), measure(textValue(item, text)));\n}\n\nfunction measure(text) {\n  return context.measureText(text).width;\n}\n\nexport function fontSize(item) {\n  return item.fontSize != null ? item.fontSize : 11;\n}\n\nfunction useCanvas(use) {\n  textMetrics.width = use && context ? measureWidth : estimateWidth;\n}\n\nexport function lineHeight(item) {\n  return item.lineHeight != null ? item.lineHeight : fontSize(item) + 2;\n}\n\nfunction lineArray(_) {\n  return isArray(_) ? _.length > 1 ? _ : _[0] : _;\n}\n\nexport function textLines(item) {\n  return lineArray(item.lineBreak && item.text && !isArray(item.text) ? item.text.split(item.lineBreak) : item.text);\n}\nexport function multiLineOffset(item) {\n  var tl = textLines(item);\n  return (isArray(tl) ? tl.length - 1 : 0) * lineHeight(item);\n}\nexport function textValue(item, line) {\n  return line == null ? '' : item.limit > 0 ? truncate(item, line) : line + '';\n}\n\nfunction truncate(item, line) {\n  var limit = +item.limit,\n      text = line + '',\n      width;\n\n  if (textMetrics.width === measureWidth) {\n    // we are using canvas\n    context.font = font(item);\n    width = measure;\n  } else {\n    // we are relying on estimates\n    currFontHeight = fontSize(item);\n    width = estimate;\n  }\n\n  if (width(text) < limit) return text;\n  var ellipsis = item.ellipsis || \"\\u2026\",\n      rtl = item.dir === 'rtl',\n      lo = 0,\n      hi = text.length,\n      mid;\n  limit -= width(ellipsis);\n\n  if (rtl) {\n    while (lo < hi) {\n      mid = lo + hi >>> 1;\n      if (width(text.slice(mid)) > limit) lo = mid + 1;else hi = mid;\n    }\n\n    return ellipsis + text.slice(lo);\n  } else {\n    while (lo < hi) {\n      mid = 1 + (lo + hi >>> 1);\n      if (width(text.slice(0, mid)) < limit) lo = mid;else hi = mid - 1;\n    }\n\n    return text.slice(0, lo) + ellipsis;\n  }\n}\n\nexport function fontFamily(item, quote) {\n  var font = item.font;\n  return (quote && font ? String(font).replace(/\"/g, '\\'') : font) || 'sans-serif';\n}\nexport function font(item, quote) {\n  return '' + (item.fontStyle ? item.fontStyle + ' ' : '') + (item.fontVariant ? item.fontVariant + ' ' : '') + (item.fontWeight ? item.fontWeight + ' ' : '') + fontSize(item) + 'px ' + fontFamily(item, quote);\n}\nexport function offset(item) {\n  // perform our own font baseline calculation\n  // why? not all browsers support SVG 1.1 'alignment-baseline' :(\n  var baseline = item.baseline,\n      h = fontSize(item);\n  return Math.round(baseline === 'top' ? 0.79 * h : baseline === 'middle' ? 0.30 * h : baseline === 'bottom' ? -0.21 * h : 0);\n}","map":null,"metadata":{},"sourceType":"module"}