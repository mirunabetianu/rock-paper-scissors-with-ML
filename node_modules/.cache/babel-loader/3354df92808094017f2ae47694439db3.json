{"ast":null,"code":"import { Transform } from 'vega-dataflow';\nimport { accessorName, error, inherits } from 'vega-util';\n/**\n * Extend tuples by joining them with values from a lookup table.\n * @constructor\n * @param {object} params - The parameters for this operator.\n * @param {Map} params.index - The lookup table map.\n * @param {Array<function(object): *} params.fields - The fields to lookup.\n * @param {Array<string>} params.as - Output field names for each lookup value.\n * @param {*} [params.default] - A default value to use if lookup fails.\n */\n\nexport default function Lookup(params) {\n  Transform.call(this, {}, params);\n}\nLookup.Definition = {\n  \"type\": \"Lookup\",\n  \"metadata\": {\n    \"modifies\": true\n  },\n  \"params\": [{\n    \"name\": \"index\",\n    \"type\": \"index\",\n    \"params\": [{\n      \"name\": \"from\",\n      \"type\": \"data\",\n      \"required\": true\n    }, {\n      \"name\": \"key\",\n      \"type\": \"field\",\n      \"required\": true\n    }]\n  }, {\n    \"name\": \"values\",\n    \"type\": \"field\",\n    \"array\": true\n  }, {\n    \"name\": \"fields\",\n    \"type\": \"field\",\n    \"array\": true,\n    \"required\": true\n  }, {\n    \"name\": \"as\",\n    \"type\": \"string\",\n    \"array\": true\n  }, {\n    \"name\": \"default\",\n    \"default\": null\n  }]\n};\nvar prototype = inherits(Lookup, Transform);\n\nprototype.transform = function (_, pulse) {\n  var out = pulse,\n      as = _.as,\n      keys = _.fields,\n      index = _.index,\n      values = _.values,\n      defaultValue = _.default == null ? null : _.default,\n      reset = _.modified(),\n      flag = reset ? pulse.SOURCE : pulse.ADD,\n      n = keys.length,\n      set,\n      m,\n      mods;\n\n  if (values) {\n    m = values.length;\n\n    if (n > 1 && !as) {\n      error('Multi-field lookup requires explicit \"as\" parameter.');\n    }\n\n    if (as && as.length !== n * m) {\n      error('The \"as\" parameter has too few output field names.');\n    }\n\n    as = as || values.map(accessorName);\n\n    set = function set(t) {\n      for (var i = 0, k = 0, j, v; i < n; ++i) {\n        v = index.get(keys[i](t));\n        if (v == null) for (j = 0; j < m; ++j, ++k) {\n          t[as[k]] = defaultValue;\n        } else for (j = 0; j < m; ++j, ++k) {\n          t[as[k]] = values[j](v);\n        }\n      }\n    };\n  } else {\n    if (!as) {\n      error('Missing output field names.');\n    }\n\n    set = function set(t) {\n      for (var i = 0, v; i < n; ++i) {\n        v = index.get(keys[i](t));\n        t[as[i]] = v == null ? defaultValue : v;\n      }\n    };\n  }\n\n  if (reset) {\n    out = pulse.reflow(true);\n  } else {\n    mods = keys.some(function (k) {\n      return pulse.modified(k.fields);\n    });\n    flag |= mods ? pulse.MOD : 0;\n  }\n\n  pulse.visit(flag, set);\n  return out.modifies(as);\n};","map":null,"metadata":{},"sourceType":"module"}