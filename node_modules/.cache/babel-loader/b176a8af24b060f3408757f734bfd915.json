{"ast":null,"code":"import { visit } from '../util/visit';\nimport { pick } from '../util/canvas/pick';\nimport { translate } from '../util/svg/transform';\nimport { truthy } from 'vega-util';\n\nfunction getImage(item, renderer) {\n  var image = item.image;\n\n  if (!image || item.url && item.url !== image.url) {\n    image = {\n      complete: false,\n      width: 0,\n      height: 0\n    };\n    renderer.loadImage(item.url).then(function (image) {\n      item.image = image;\n      item.image.url = item.url;\n    });\n  }\n\n  return image;\n}\n\nfunction imageWidth(item, image) {\n  return item.width != null ? item.width : !image || !image.width ? 0 : item.aspect !== false && item.height ? item.height * image.width / image.height : image.width;\n}\n\nfunction imageHeight(item, image) {\n  return item.height != null ? item.height : !image || !image.height ? 0 : item.aspect !== false && item.width ? item.width * image.height / image.width : image.height;\n}\n\nfunction imageXOffset(align, w) {\n  return align === 'center' ? w / 2 : align === 'right' ? w : 0;\n}\n\nfunction imageYOffset(baseline, h) {\n  return baseline === 'middle' ? h / 2 : baseline === 'bottom' ? h : 0;\n}\n\nfunction attr(emit, item, renderer) {\n  var image = getImage(item, renderer),\n      x = item.x || 0,\n      y = item.y || 0,\n      w = imageWidth(item, image),\n      h = imageHeight(item, image),\n      a = item.aspect === false ? 'none' : 'xMidYMid';\n  x -= imageXOffset(item.align, w);\n  y -= imageYOffset(item.baseline, h);\n\n  if (!image.src && image.toDataURL) {\n    emit('href', image.toDataURL(), 'http://www.w3.org/1999/xlink', 'xlink:href');\n  } else {\n    emit('href', image.src || '', 'http://www.w3.org/1999/xlink', 'xlink:href');\n  }\n\n  emit('transform', translate(x, y));\n  emit('width', w);\n  emit('height', h);\n  emit('preserveAspectRatio', a);\n}\n\nfunction bound(bounds, item) {\n  var image = item.image,\n      x = item.x || 0,\n      y = item.y || 0,\n      w = imageWidth(item, image),\n      h = imageHeight(item, image);\n  x -= imageXOffset(item.align, w);\n  y -= imageYOffset(item.baseline, h);\n  return bounds.set(x, y, x + w, y + h);\n}\n\nfunction draw(context, scene, bounds) {\n  var renderer = this;\n  visit(scene, function (item) {\n    if (bounds && !bounds.intersects(item.bounds)) return; // bounds check\n\n    var image = getImage(item, renderer),\n        x = item.x || 0,\n        y = item.y || 0,\n        w = imageWidth(item, image),\n        h = imageHeight(item, image),\n        opacity,\n        ar0,\n        ar1,\n        t;\n    x -= imageXOffset(item.align, w);\n    y -= imageYOffset(item.baseline, h);\n\n    if (item.aspect !== false) {\n      ar0 = image.width / image.height;\n      ar1 = item.width / item.height;\n\n      if (ar0 === ar0 && ar1 === ar1 && ar0 !== ar1) {\n        if (ar1 < ar0) {\n          t = w / ar0;\n          y += (h - t) / 2;\n          h = t;\n        } else {\n          t = h * ar0;\n          x += (w - t) / 2;\n          w = t;\n        }\n      }\n    }\n\n    if (image.complete || image.toDataURL) {\n      context.globalAlpha = (opacity = item.opacity) != null ? opacity : 1;\n      context.imageSmoothingEnabled = item.smooth !== false;\n      context.drawImage(image, x, y, w, h);\n    }\n  });\n}\n\nexport default {\n  type: 'image',\n  tag: 'image',\n  nested: false,\n  attr: attr,\n  bound: bound,\n  draw: draw,\n  pick: pick(),\n  isect: truthy,\n  // bounds check is sufficient\n  get: getImage,\n  xOffset: imageXOffset,\n  yOffset: imageYOffset\n};","map":null,"metadata":{},"sourceType":"module"}