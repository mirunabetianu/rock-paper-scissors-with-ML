{"ast":null,"code":"import { array32 } from './arrays';\nimport { bisectLeft, bisectRight, permute } from 'd3-array';\n/**\n * Maintains a list of values, sorted by key.\n */\n\nexport default function SortedIndex() {\n  var _index = array32(0),\n      value = [],\n      _size = 0;\n\n  function insert(key, data, base) {\n    if (!data.length) return [];\n    var n0 = _size,\n        n1 = data.length,\n        addv = Array(n1),\n        addi = array32(n1),\n        oldv,\n        oldi,\n        i;\n\n    for (i = 0; i < n1; ++i) {\n      addv[i] = key(data[i]);\n      addi[i] = i;\n    }\n\n    addv = sort(addv, addi);\n\n    if (n0) {\n      oldv = value;\n      oldi = _index;\n      value = Array(n0 + n1);\n      _index = array32(n0 + n1);\n      merge(base, oldv, oldi, n0, addv, addi, n1, value, _index);\n    } else {\n      if (base > 0) for (i = 0; i < n1; ++i) {\n        addi[i] += base;\n      }\n      value = addv;\n      _index = addi;\n    }\n\n    _size = n0 + n1;\n    return {\n      index: addi,\n      value: addv\n    };\n  }\n\n  function remove(num, map) {\n    // map: index -> remove\n    var n = _size,\n        idx,\n        i,\n        j; // seek forward to first removal\n\n    for (i = 0; !map[_index[i]] && i < n; ++i) {\n      ;\n    } // condense index and value arrays\n\n\n    for (j = i; i < n; ++i) {\n      if (!map[idx = _index[i]]) {\n        _index[j] = idx;\n        value[j] = value[i];\n        ++j;\n      }\n    }\n\n    _size = n - num;\n  }\n\n  function reindex(map) {\n    for (var i = 0, n = _size; i < n; ++i) {\n      _index[i] = map[_index[i]];\n    }\n  }\n\n  function bisect(range, array) {\n    var n;\n\n    if (array) {\n      n = array.length;\n    } else {\n      array = value;\n      n = _size;\n    }\n\n    return [bisectLeft(array, range[0], 0, n), bisectRight(array, range[1], 0, n)];\n  }\n\n  return {\n    insert: insert,\n    remove: remove,\n    bisect: bisect,\n    reindex: reindex,\n    index: function index() {\n      return _index;\n    },\n    size: function size() {\n      return _size;\n    }\n  };\n}\n\nfunction sort(values, index) {\n  values.sort.call(index, function (a, b) {\n    var x = values[a],\n        y = values[b];\n    return x < y ? -1 : x > y ? 1 : 0;\n  });\n  return permute(values, index);\n}\n\nfunction merge(base, value0, index0, n0, value1, index1, n1, value, index) {\n  var i0 = 0,\n      i1 = 0,\n      i;\n\n  for (i = 0; i0 < n0 && i1 < n1; ++i) {\n    if (value0[i0] < value1[i1]) {\n      value[i] = value0[i0];\n      index[i] = index0[i0++];\n    } else {\n      value[i] = value1[i1];\n      index[i] = index1[i1++] + base;\n    }\n  }\n\n  for (; i0 < n0; ++i0, ++i) {\n    value[i] = value0[i0];\n    index[i] = index0[i0];\n  }\n\n  for (; i1 < n1; ++i1, ++i) {\n    value[i] = value1[i1];\n    index[i] = index1[i1] + base;\n  }\n}","map":null,"metadata":{},"sourceType":"module"}