{"ast":null,"code":"import Constants from './constants';\nimport Functions from './functions';\nimport { error, hasOwnProperty, isFunction, isString, toSet } from 'vega-util';\n\nfunction stripQuotes(s) {\n  var n = s && s.length - 1;\n  return n && (s[0] === '\"' && s[n] === '\"' || s[0] === '\\'' && s[n] === '\\'') ? s.slice(1, -1) : s;\n}\n\nexport default function (opt) {\n  opt = opt || {};\n  var whitelist = opt.whitelist ? toSet(opt.whitelist) : {},\n      blacklist = opt.blacklist ? toSet(opt.blacklist) : {},\n      constants = opt.constants || Constants,\n      functions = (opt.functions || Functions)(visit),\n      globalvar = opt.globalvar,\n      fieldvar = opt.fieldvar,\n      globals = {},\n      fields = {},\n      memberDepth = 0;\n  var outputGlobal = isFunction(globalvar) ? globalvar : function (id) {\n    return globalvar + '[\"' + id + '\"]';\n  };\n\n  function visit(ast) {\n    if (isString(ast)) return ast;\n    var generator = Generators[ast.type];\n    if (generator == null) error('Unsupported type: ' + ast.type);\n    return generator(ast);\n  }\n\n  var Generators = {\n    Literal: function Literal(n) {\n      return n.raw;\n    },\n    Identifier: function Identifier(n) {\n      var id = n.name;\n\n      if (memberDepth > 0) {\n        return id;\n      } else if (hasOwnProperty(blacklist, id)) {\n        return error('Illegal identifier: ' + id);\n      } else if (hasOwnProperty(constants, id)) {\n        return constants[id];\n      } else if (hasOwnProperty(whitelist, id)) {\n        return id;\n      } else {\n        globals[id] = 1;\n        return outputGlobal(id);\n      }\n    },\n    MemberExpression: function MemberExpression(n) {\n      var d = !n.computed;\n      var o = visit(n.object);\n      if (d) memberDepth += 1;\n      var p = visit(n.property);\n\n      if (o === fieldvar) {\n        // strip quotes to sanitize field name (#1653)\n        fields[stripQuotes(p)] = 1;\n      }\n\n      if (d) memberDepth -= 1;\n      return o + (d ? '.' + p : '[' + p + ']');\n    },\n    CallExpression: function CallExpression(n) {\n      if (n.callee.type !== 'Identifier') {\n        error('Illegal callee type: ' + n.callee.type);\n      }\n\n      var callee = n.callee.name;\n      var args = n.arguments;\n      var fn = hasOwnProperty(functions, callee) && functions[callee];\n      if (!fn) error('Unrecognized function: ' + callee);\n      return isFunction(fn) ? fn(args) : fn + '(' + args.map(visit).join(',') + ')';\n    },\n    ArrayExpression: function ArrayExpression(n) {\n      return '[' + n.elements.map(visit).join(',') + ']';\n    },\n    BinaryExpression: function BinaryExpression(n) {\n      return '(' + visit(n.left) + n.operator + visit(n.right) + ')';\n    },\n    UnaryExpression: function UnaryExpression(n) {\n      return '(' + n.operator + visit(n.argument) + ')';\n    },\n    ConditionalExpression: function ConditionalExpression(n) {\n      return '(' + visit(n.test) + '?' + visit(n.consequent) + ':' + visit(n.alternate) + ')';\n    },\n    LogicalExpression: function LogicalExpression(n) {\n      return '(' + visit(n.left) + n.operator + visit(n.right) + ')';\n    },\n    ObjectExpression: function ObjectExpression(n) {\n      return '{' + n.properties.map(visit).join(',') + '}';\n    },\n    Property: function Property(n) {\n      memberDepth += 1;\n      var k = visit(n.key);\n      memberDepth -= 1;\n      return k + ':' + visit(n.value);\n    }\n  };\n\n  function codegen(ast) {\n    var result = {\n      code: visit(ast),\n      globals: Object.keys(globals),\n      fields: Object.keys(fields)\n    };\n    globals = {};\n    fields = {};\n    return result;\n  }\n\n  codegen.functions = functions;\n  codegen.constants = constants;\n  return codegen;\n}","map":null,"metadata":{},"sourceType":"module"}