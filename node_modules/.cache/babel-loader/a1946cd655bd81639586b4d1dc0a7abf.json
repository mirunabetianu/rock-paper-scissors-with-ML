{"ast":null,"code":"import { getDataRef } from './data';\nimport parseSpec from '../spec';\nimport DataScope from '../../DataScope';\nimport { ref } from '../../util';\nimport { Collect, Facet, PreFacet, Sieve } from '../../transforms';\nimport { error, stringValue } from 'vega-util';\nexport default function (spec, scope, group) {\n  var facet = spec.from.facet,\n      name = facet.name,\n      data = getDataRef(facet, scope),\n      subscope,\n      source,\n      values,\n      op;\n\n  if (!facet.name) {\n    error('Facet must have a name: ' + stringValue(facet));\n  }\n\n  if (!facet.data) {\n    error('Facet must reference a data set: ' + stringValue(facet));\n  }\n\n  if (facet.field) {\n    op = scope.add(PreFacet({\n      field: scope.fieldRef(facet.field),\n      pulse: data\n    }));\n  } else if (facet.groupby) {\n    op = scope.add(Facet({\n      key: scope.keyRef(facet.groupby),\n      group: ref(scope.proxy(group.parent)),\n      pulse: data\n    }));\n  } else {\n    error('Facet must specify groupby or field: ' + stringValue(facet));\n  } // initialize facet subscope\n\n\n  subscope = scope.fork();\n  source = subscope.add(Collect());\n  values = subscope.add(Sieve({\n    pulse: ref(source)\n  }));\n  subscope.addData(name, new DataScope(subscope, source, source, values));\n  subscope.addSignal('parent', null); // parse faceted subflow\n\n  op.params.subflow = {\n    $subflow: parseSpec(spec, subscope).toRuntime()\n  };\n}","map":null,"metadata":{},"sourceType":"module"}