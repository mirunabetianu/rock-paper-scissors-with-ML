{"ast":null,"code":"import expression from './expression';\nimport field from './field';\nimport property from './property';\nimport { ScalePrefix } from 'vega-functions';\nimport { hasOwnProperty, isString, stringValue } from 'vega-util';\nexport default function (enc, value, scope, params, fields) {\n  var scale = getScale(enc.scale, scope, params, fields),\n      interp,\n      func,\n      flag;\n\n  if (enc.range != null) {\n    // pull value from scale range\n    interp = +enc.range;\n    func = scale + '.range()';\n    value = interp === 0 ? func + '[0]' : '($=' + func + ',' + (interp === 1 ? '$[$.length-1]' : '$[0]+' + interp + '*($[$.length-1]-$[0])') + ')';\n  } else {\n    // run value through scale and/or pull scale bandwidth\n    if (value !== undefined) value = scale + '(' + value + ')';\n\n    if (enc.band && (flag = hasBandwidth(enc.scale, scope))) {\n      func = scale + '.bandwidth';\n\n      if (enc.band.signal) {\n        interp = func + '()*' + property(enc.band, scope, params, fields);\n      } else {\n        interp = +enc.band;\n        interp = func + '()' + (interp === 1 ? '' : '*' + interp);\n      } // if we don't know the scale type, check for bandwidth\n\n\n      if (flag < 0) interp = '(' + func + '?' + interp + ':0)';\n      value = (value ? value + '+' : '') + interp;\n\n      if (enc.extra) {\n        // include logic to handle extraneous elements\n        value = '(datum.extra?' + scale + '(datum.extra.value):' + value + ')';\n      }\n    }\n\n    if (value == null) value = '0';\n  }\n\n  return value;\n}\n\nfunction hasBandwidth(name, scope) {\n  if (!isString(name)) return -1;\n  var type = scope.scaleType(name);\n  return type === 'band' || type === 'point' ? 1 : 0;\n}\n\nexport function getScale(name, scope, params, fields) {\n  var scaleName;\n\n  if (isString(name)) {\n    // direct scale lookup; add scale as parameter\n    scaleName = ScalePrefix + name;\n\n    if (!hasOwnProperty(params, scaleName)) {\n      params[scaleName] = scope.scaleRef(name);\n    }\n\n    scaleName = stringValue(scaleName);\n  } else {\n    // indirect scale lookup; add all scales as parameters\n    for (scaleName in scope.scales) {\n      params[ScalePrefix + scaleName] = scope.scaleRef(scaleName);\n    }\n\n    scaleName = stringValue(ScalePrefix) + '+' + (name.signal ? '(' + expression(name.signal, scope, params, fields) + ')' : field(name, scope, params, fields));\n  }\n\n  return '_[' + scaleName + ']';\n}","map":null,"metadata":{},"sourceType":"module"}